{% extends "base.html" %}
{% block content %}

{% if test %}
  <div class="alert alert-warning" role="alert">
    <strong>Versión de prueba:</strong> No se enviará ningún e-mail.
  </div>
{% endif %}

<p class="lead">
Cada entrega quedará registrada y le llegará a tu corrector asignado.
</p>

<form class="form-horizontal" role="form" method="post" enctype="multipart/form-data">
  {% if alert %}<div class="alert alert-danger">{{ alert }}</div>{% endif %}

  <div class="form-group" id="fg_tp">
    <label for="tp" class="col-xs-2 control-label">Entrega:</label>
    <div class="col-xs-4">
      <select class="form-control" name="tp" id="tp" value="">
        <option style="display:none" selected value></option>
        {% for tp in entregas|sort %}
          <option value="{{tp}}">{{tp}}</option>
        {% endfor %}
      </select>
    </div>
  </div>
  <div class="form-group" id="fg_padron">
    <label for="padron" class="col-xs-2 control-label">Padrón:</label>
    <div class="col-xs-4">
      <div class="input-group">
        <input type="text" class="form-control" name="padron" id="padron" value="" placeholder="Padrón">
        <span class="input-group-addon"></span>
      </div>
      <span class="help-block" id="padron_help">Número de padrón o legajo</span>
    </div>
  </div>
  <div class="form-group" id="fg_adjuntos">
    <label for="file0" class="col-xs-2 control-label">Adjuntos:</label>
    <div class="col-xs-4">
      <div id="files">
      </div>
      <button type="button" class="btn btn-default btn-xs btn-block" id="add_file" aria-label="Agregar adjunto">
        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
      </button>
      <p class="help-block">
        Formatos aceptados:
        <ul>
          <li><b>Informe:</b> <code>.pdf</code>, <code>.txt</code>
          <li><b>Código:</b> <code>.zip</code>, <code>.py</code>
        </ul>
      </p>
    </div>
  </div>
  <div class="form-group" id="fg_body">
    <label for="body" class="col-xs-2 control-label">Mensaje (opcional):</label>
    <div class="col-xs-4">
      <textarea class="form-control" name="body" id="body"></textarea>
      <span class="help-block">Cualquier aclaración de utilidad para el corrector</span>
    </div>
  </div>
  <div class="form-group">
    <div class="col-xs-2"></div>
    <div class="col-xs-4">
      <div class="g-recaptcha" data-sitekey="{{ recaptcha_site_id }}"></div>
    </div>
  </div>
  <div class="form-group">
    <div class="col-xs-2"></div>
    <div class="col-xs-4">
      <button disabled type="submit" id="submit" class="btn btn-primary btn-lg">Enviar entrega</button>
    </div>
  </div>
</form>

<script>
document.addEventListener("DOMContentLoaded", function() {
  $('#tp').on('input', validate);
  $('#padron').on('input', validate);

  addFileInput();
  $('#add_file').on('click', addFileInput);
  $(document).on('click', '.rm_file', rmFileInput);
});

var correctores = JSON.parse('{{correctores_json|safe}}');
var entregas = JSON.parse('{{entregas_json|safe}}');
var grupos = invert(JSON.parse('{{grupos_json|safe}}'));

function invert(dict) {
    var res = {};
    var ks = Object.keys(dict);
    for (var i = 0; i < ks.length; i++) {
        var xs = dict[ks[i]];
        for (var j = 0; j < xs.length; j++) {
            res[xs[j]] = ks[i];
        }
    }
    return res;
}

function addFileInput() {
  var inputGroup = $([
    '<div class="input-group">',
      '<label class="input-group-btn">',
        '<span class="btn btn-default">',
          '<span class="glyphicon glyphicon-paperclip" aria-hidden="true"></span>',
          '<input type="file" style="display: none;" name="files">',
        '</span>',
      '</label>',
      '<input type="text" class="form-control filename" readonly>',
      '<span class="input-group-btn">',
        '<button class="btn btn-default rm_file" type="button">',
          '<span class="glyphicon glyphicon-trash" aria-hidden="true"></span>',
        '</button>',
      '</span>',
    '</div>'
  ].join(''));
  $('#files').append(inputGroup);
  $(inputGroup).find('input[type="file"]').on('change', setFile);
}

function rmFileInput() {
  $(this).closest('.input-group').remove();
}

function setFile() {
  var filename = $(this).val().replace(/\\/g, '/').replace(/.*\//, '');
  var inputGroup = $(this).closest('.input-group');
  inputGroup.find('.filename').val(filename);
  validate();
}

function getFilenames() {
  return $('#files').find('input[type="file"]')
    .map(function () { return $(this).val() }).get();
}

function clone(prefix, container) {
  var id = prefix + $(container).children().length;
  var newInput = $(container).children().last().clone();
  newInput.val('');
  newInput.attr('id', id);
  newInput.attr('name', prefix);
  newInput.appendTo($(container))
}

function validate() {
console.log('V');
  var tp = validateTP();
  var padronValid = validatePadron(tp);
  var filesValid = validateFiles();
  var valid = !!tp && padronValid && filesValid;
  $('#submit').prop('disabled', !valid);
}

function validateTP() {
  var tp = validateAlNum($('#tp'));
  var valid = tp in entregas;
  $('#tp').parent().toggleClass('has-success', valid);
  if (valid) {
    if (entregas[tp] === 'i') { // individual
      $('#fg_padron label').html('Padrón:');
      $('#fg_padron .help-block').html('Número de padrón o legajo:');
      $('#padron').attr('placeholder', 'Padrón');
    } else { // grupal
      $('#fg_padron label').html('Padrón o grupo:');
      $('#fg_padron .help-block').html('Número de padrón o legajo de algún integrante, o identificador del grupo (ejemplo: "G04"):');
      $('#padron').attr('placeholder', 'Padrón o grupo');
    }
  }
  return tp;
}

function validatePadron(tp) {
  var input = $('#padron')
  var padron = validateAlNum(input);
  var valid = false;
  if (padron) {
    var corrector = null;
    if (entregas[tp] === 'g') { // grupal
      if (grupos[padron]) {
        padron = grupos[padron];
      }
    }
    if (padron in correctores && tp in correctores[padron]) {
      corrector = correctores[padron][tp];
      valid = true;
    }
    input.parent().find('span').html(corrector ? '<b>Corrector:</b> ' + corrector : '');
    input.parent().toggleClass('has-success', !!corrector);
  }
  return valid;
}

function validateFiles() {
  var valid = false;
  $('#files').find('input[type="file"]').each(function () {
    var thisValid = !!($(this).val());
    valid = valid || thisValid;
    $(this).closest('.input-group').toggleClass('has-success', thisValid);
  });
  return valid;
}

function validateAlNum(el) {
  if (el.length === 0) {
    return false;
  }
  var value = el.val().trim().toUpperCase();
  var valid = /^[\d\w]+$/.test(value);
  return valid ? value : false;
}
</script>
{% endblock %}
