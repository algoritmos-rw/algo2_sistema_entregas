{% extends "base.html" %}
{% block content %}

<p class="lead">
Cada entrega quedará registrada y le llegará a tu corrector asignado.
</p>

<form class="form-horizontal" role="form" method="post" enctype="multipart/form-data">
  {% if alert %}<div class="alert alert-danger">{{ alert }}</div>{% endif %}

  <div class="form-group" id="fg_tp">
    <label for="tp" class="col-xs-2 control-label">Entrega:</label>
    <div class="col-xs-4">
      <input type="text" class="form-control upper" name="tp" id="tp" value="">
      <span id="helpBlock" class="help-block">Ejemplos: TP1, TP2, EJ1, etc</span>
    </div>
  </div>
  <div class="form-group" id="fg_integrantes">
    <label for="padron0" class="col-xs-2 control-label">Integrantes:</label>
    <div class="col-xs-4">
      <div id="padrones">
        <input type="text" class="form-control" name="padron" id="padron0" value="" placeholder="Padrón">
      </div>
      <button type="button" class="btn btn-default btn-xs btn-block" id="add_padron" aria-label="Agregar integrante">
        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
      </button>
      <span id="helpBlock" class="help-block">Número de padrón o legajo</span>
    </div>
  </div>
  <div class="form-group" id="fg_adjuntos">
    <label for="file0" class="col-xs-2 control-label">Adjuntos:</label>
    <div class="col-xs-4">
      <label class="btn btn-default btn-file">
        Elegir archivos<input type="file" multiple style="display: none" name="files" id="files">
      </label>
      <pre id="filenames" style="display: none"></pre>
      <p class="help-block">
        Formatos aceptados:
        <ul>
          <li><b>Informe:</b> <code>.pdf</code>, <code>.txt</code>
          <li><b>Código:</b> <code>.zip</code>, <code>.py</code>
        </ul>
    </div>
  </div>
  <div class="form-group" id="fg_body">
    <label for="body" class="col-xs-2 control-label">Mensaje (opcional):</label>
    <div class="col-xs-4">
      <textarea class="form-control" name="body" id="body"></textarea>
      <span id="helpBlock" class="help-block">Cualquier aclaración de utilidad para el corrector</span>
    </div>
  </div>
  <div class="form-group">
    <div class="col-xs-2"></div>
    <div class="col-xs-4">
      <button disabled type="submit" id="submit" class="btn btn-primary btn-lg">Enviar entrega</button>
    </div>
  </div>
</form>

<script>
document.addEventListener("DOMContentLoaded", function() {
  $('#tp').on('input', validate);
  $(document).on('input', '#padrones input', validate);
  $('#add_padron').on('click', addPadron);
  $('#files').on('change', showFiles);
});

function addPadron() {
  clone('padron', '#padrones');
}

function showFiles() {
  var names = [];
  for (var i = 0; i < $(this).get(0).files.length; ++i) {
    names.push($(this).get(0).files[i].name);
  }
  $("#filenames").html(names.join('\n'));
  $("#filenames").toggle(names.length > 0);
}

function clone(prefix, container) {
  var id = prefix + $(container).children().length;
  var newInput = $(container).children().last().clone();
  newInput.val('');
  newInput.attr('id', id);
  newInput.attr('name', prefix);
  newInput.appendTo($(container))
}

function validate() {
  var tp = validateAlNum($('#tp'), $('fg_tp'));
  var padrones = validatePadrones();
  var valid = !!tp && !!padrones;
  $('#submit').prop('disabled', !valid);
}

function validatePadrones() {
  var padrones = []
  var valid = true;
  $('#padrones').children().each(function(i) {
    var el = $(this);
    if (!el.val()) {
      return;
    }
    var padron = validateAlNum(el);
    if (padron) {
      padrones.push(padron);
    } else {
      valid = false;
    }
  });
  valid = valid && padrones.length > 0;
  showValidation($('fg_integrantes'), valid);
  return valid ? padrones : false;
}

function validateAlNum(el, formGoup) {
  if (el.length === 0) {
    return false;
  }
  var value = el.val().trim().toUpperCase();
  var valid = /^[\d\w]+$/.test(value);
  if (formGoup) {
    showValidation(formGoup, valid);
  }
  return valid ? value : false;
}

function showValidation(el, valid) {
  el.toggleClass('has-error', !valid);
}
</script>
{% endblock %}
